'use strict';

angular.module('deckApp.delivery.executions.service', [
  'ui.router',
  'deckApp.scheduler',
  'deckApp.orchestratedItem.service',
  'deckApp.settings',
  'deckApp.utils.rx',
  'deckApp.utils.appendTransform',
  'deckApp.delivery.executionTransformer.service'
])
  .factory('executionsService', function($stateParams, $http, $timeout, $q, scheduler, orchestratedItem, settings, RxService, appendTransform, executionsTransformer) {

    function getExecutions(applicationName) {

      if (applicationName) {
        var stub = [{'id':'15627899-ed80-4886-9b1a-90d7f09ec378','application':'mimirdemo','appConfig':{},'stages':[{'id':'3f9fa1b6-dc40-4edd-bbcb-06bf1f8194ee','type':'findAmi','name':'Find AMI','startTime':1429039967364,'endTime':1429039967768,'status':'SUCCEEDED','context':{'account':'test','amiDetails':[{'ami':'ami-377d9e73','architecture':'x86_64','blockDeviceMappings':[{'deviceName':'/dev/sda1','ebs':{'encrypted':false,'snapshotId':'snap-4f188e6d','volumeSize':10,'volumeType':'standard'}},{'deviceName':'/dev/sdb','virtualName':'ephemeral0'},{'deviceName':'/dev/sdc','virtualName':'ephemeral1'},{'deviceName':'/dev/sdd','virtualName':'ephemeral2'},{'deviceName':'/dev/sde','virtualName':'ephemeral3'}],'commit':'81f01bc','description':'name=mimirdemo, arch=x86_64, ancestor_name=trustybase-x86_64-201503201659-ebs, ancestor_id=ami-95a342d1, ancestor_version=nflx-base-1.445-h396.40e956d','hypervisor':'xen','imageId':'ami-377d9e73','imageLocation':'179727101194/mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageName':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageType':'machine','jenkins':{'host':'http://spinnaker.builds.test.netflix.net/','name':'litespin','number':'3'},'name':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','ownerId':'179727101194','package_name':'mimirdemo','productCodes':[],'public':false,'region':'us-west-1','rootDeviceName':'/dev/sda1','rootDeviceType':'ebs','sourceServerGroup':'mimirdemo-test-v117','sriovNetSupport':'simple','state':'available','tags':[{'key':'appversion','value':'mimirdemo-2.0-h3.81f01bc/litespin/3'},{'key':'base_ami_version','value':'nflx-base-1.445-h396.40e956d'},{'key':'build_host','value':'http://spinnaker.builds.test.netflix.net/'},{'key':'creation_time','value':'2015-04-10 05:36:01 UTC'},{'key':'creator','value':'cfieber'}],'version':'2.0','virtualizationType':'hvm'}],'batch.task.id.findAmi':2,'cluster':'mimirdemo-test','onlyEnabled':true,'regions':['us-west-1'],'selectionStrategy':'LARGEST'},'immutable':false,'initializationStage':false,'tasks':[{'id':'1','name':'findAmi','startTime':1429039967381,'endTime':1429039967760,'status':'SUCCEEDED'}],'parentStageId':null,'syntheticStageOwner':null,'scheduledTime':0},{'id':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35','type':'canary','name':'Canary','startTime':1429040389428,'endTime':null,'status':'RUNNING','context':{'baseline':{'account':'prod','cluster':'mimirdemo'},'batch.task.id.registerCanary':25,'canaries':[{'account':'prod','application':'mimirdemo','availabilityZones':{'us-west-1':['us-west-1a','us-west-1c']},'capacity':{'desired':1,'max':1,'min':1},'cooldown':10,'dirty':{'securityGroups':null},'ebsOptimized':false,'freeFormDetails':'','healthCheckGracePeriod':600,'healthCheckType':'EC2','iamRole':'BaseIAMRole','instanceMonitoring':true,'instanceType':'t2.micro','keyPair':'nf-prod-keypair-a','loadBalancers':['mimirdemo--frontend'],'provider':'aws','securityGroups':['sg-b575ded0','sg-b775ded2','sg-121caa77'],'stack':'','strategy':'highlander','subnetType':'internal (vpc0)','suspendedProcesses':[],'terminationPolicies':['Default']}],'canary':{'id':'mimirdemo:com.netflix.spinnaker.mine.model.Canary:4fad7a13-a217-48cf-a540-e2a4d5bce248','application':'mimirdemo','launchedDate':1429040389040,'canaryConfig':{'id':'mimirdemo:com.netflix.spinnaker.mine.model.config.CanaryConfig:sthadeshwar','application':'mimirdemo','name':'sthadeshwar','lifetimeHours':4,'combinedCanaryResultStrategy':'LOWEST','canaryAnalysisConfig':{'name':'generic-canary','beginCanaryAnalysisAfterMins':30,'notificationHours':[2,3,4],'canaryAnalysisIntervalMins':30,'params':null},'canarySuccessCriteria':{'canaryResultScore':90},'canaryHealthCheckHandler':{'@class':'com.netflix.spinnaker.mine.CanaryResultHealthCheckHandler','minimumCanaryResultScore':490}},'canaryDeployments':[{'canaryCluster':{'name':'mimirdemo--canary-v004','type':'aws','accountName':'prod','region':'us-west-1','buildId':null,'imageId':'ami-377d9e73','id':'mimirdemo--canary-v004:aws:prod:us-west-1'},'baselineCluster':{'name':'mimirdemo--baseline-v004','type':'aws','accountName':'prod','region':'us-west-1','buildId':null,'imageId':'ami-717d9e35','id':'mimirdemo--baseline-v004:aws:prod:us-west-1'},'id':'mimirdemo--canary-v004:aws:prod:us-west-1|mimirdemo--baseline-v004:aws:prod:us-west-1','canaryResult':{'id':'mimirdemo:com.netflix.spinnaker.mine.model.Canary:4fad7a13-a217-48cf-a540-e2a4d5bce248:mimirdemo--canary-v004:aws:prod:us-west-1|mimirdemo--baseline-v004:aws:prod:us-west-1:com.netflix.spinnaker.mine.model.CanaryAnalysisResult:523450ab-5fdc-40d0-b6ec-cd5a91f7f5e2','canaryDeploymentId':'mimirdemo:com.netflix.spinnaker.mine.model.Canary:4fad7a13-a217-48cf-a540-e2a4d5bce248:mimirdemo--canary-v004:aws:prod:us-west-1|mimirdemo--baseline-v004:aws:prod:us-west-1','score':0,'result':'FAILURE','timeDuration':{'duration':1,'unit':'HOURS','durationString':'PT1H'},'lastUpdated':1429052065598,'canaryReportURL':'http://canary-report.prod.netflix.net/#/prod/us-west-1/generic-canary/generic-canary_us-west-1_1','additionalAttributes':{'metricsCount':14}},'health':'HEALTHY'}],'canaryResult':{'overallResult':'FAILURE','overallScore':0,'lastUpdated':1429052191251,'lastCanaryAnalysisResults':[{'id':'mimirdemo:com.netflix.spinnaker.mine.model.Canary:4fad7a13-a217-48cf-a540-e2a4d5bce248:mimirdemo--canary-v004:aws:prod:us-west-1|mimirdemo--baseline-v004:aws:prod:us-west-1:com.netflix.spinnaker.mine.model.CanaryAnalysisResult:523450ab-5fdc-40d0-b6ec-cd5a91f7f5e2','canaryDeploymentId':'mimirdemo:com.netflix.spinnaker.mine.model.Canary:4fad7a13-a217-48cf-a540-e2a4d5bce248:mimirdemo--canary-v004:aws:prod:us-west-1|mimirdemo--baseline-v004:aws:prod:us-west-1','score':0,'result':'FAILURE','timeDuration':{'duration':1,'unit':'HOURS','durationString':'PT1H'},'lastUpdated':1429052065598,'canaryReportURL':'http://canary-report.prod.netflix.net/#/prod/us-west-1/generic-canary/generic-canary_us-west-1_1','additionalAttributes':{'metricsCount':14}}]},'status':'LAUNCHED','health':'UNKNOWN','owner':{'name':'Satyajit Thadeshwar','email':'sthadeshwar@netflix.com'},'watchers':[{'name':'Cameron Fieber','email':'cfieber@netflix.com'},{'name':'Chris Berry','email':'chrisb@netflix.com'}],'recipients':[{'name':'Satyajit Thadeshwar','email':'sthadeshwar@netflix.com'},{'name':'Cameron Fieber','email':'cfieber@netflix.com'},{'name':'Chris Berry','email':'chrisb@netflix.com'}]},'deploymentDetails':[{'ami':'ami-377d9e73','architecture':'x86_64','blockDeviceMappings':[{'deviceName':'/dev/sda1','ebs':{'encrypted':false,'snapshotId':'snap-4f188e6d','volumeSize':10,'volumeType':'standard'}},{'deviceName':'/dev/sdb','virtualName':'ephemeral0'},{'deviceName':'/dev/sdc','virtualName':'ephemeral1'},{'deviceName':'/dev/sdd','virtualName':'ephemeral2'},{'deviceName':'/dev/sde','virtualName':'ephemeral3'}],'commit':'81f01bc','description':'name=mimirdemo, arch=x86_64, ancestor_name=trustybase-x86_64-201503201659-ebs, ancestor_id=ami-95a342d1, ancestor_version=nflx-base-1.445-h396.40e956d','hypervisor':'xen','imageId':'ami-377d9e73','imageLocation':'179727101194/mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageName':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageType':'machine','jenkins':{'host':'http://spinnaker.builds.test.netflix.net/','name':'litespin','number':'3'},'name':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','ownerId':'179727101194','package_name':'mimirdemo','productCodes':[],'public':false,'region':'us-west-1','rootDeviceName':'/dev/sda1','rootDeviceType':'ebs','sourceServerGroup':'mimirdemo-test-v117','sriovNetSupport':'simple','state':'available','tags':[{'key':'appversion','value':'mimirdemo-2.0-h3.81f01bc/litespin/3'},{'key':'base_ami_version','value':'nflx-base-1.445-h396.40e956d'},{'key':'build_host','value':'http://spinnaker.builds.test.netflix.net/'},{'key':'creation_time','value':'2015-04-10 05:36:01 UTC'},{'key':'creator','value':'cfieber'}],'version':'2.0','virtualizationType':'hvm'}],'owner':{'email':'cfieber@netflix.com','name':'Cameron Fieber'},'scaleUp':{'capacity':'3','delay':'30','enabled':true},'watchers':[]},'immutable':false,'initializationStage':false,'tasks':[{'id':'1','name':'registerCanary','startTime':1429040389431,'endTime':1429040389847,'status':'SUCCEEDED'},{'id':'2','name':'monitorCanary','startTime':1429040389878,'endTime':null,'status':'RUNNING'},{'id':'3','name':'cleanupCanary','startTime':null,'endTime':null,'status':'NOT_STARTED'},{'id':'4','name':'monitorCleanup','startTime':null,'endTime':null,'status':'NOT_STARTED'},{'id':'5','name':'completeCanary','startTime':null,'endTime':null,'status':'NOT_STARTED'}],'parentStageId':null,'syntheticStageOwner':null,'scheduledTime':0},{'id':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35-1-DeployCanary','type':'deployCanary','name':'Deploy Canary','startTime':1429039967801,'endTime':1429040389408,'status':'SUCCEEDED','context':{'baseline':{'account':'prod','cluster':'mimirdemo'},'batch.task.id.beginParallel':3,'batch.task.id.completeParallel':24,'batch.task.id.setupParallelDeploy':5,'canaryConfig':{'canaryAnalysisConfig':{'beginCanaryAnalysisAfterMins':'10','canaryAnalysisIntervalMinutes':'30','name':'generic-canary','notificationHours':null},'canaryHealthCheckHandler':{'minimumCanaryResultScore':'75'},'canarySuccessCriteria':{'canaryResultScore':'95'},'combinedCanaryResultStrategy':'LOWEST','lifetimeHours':'10'},'deploymentDetails':[{'ami':'ami-377d9e73','architecture':'x86_64','blockDeviceMappings':[{'deviceName':'/dev/sda1','ebs':{'encrypted':false,'snapshotId':'snap-4f188e6d','volumeSize':10,'volumeType':'standard'}},{'deviceName':'/dev/sdb','virtualName':'ephemeral0'},{'deviceName':'/dev/sdc','virtualName':'ephemeral1'},{'deviceName':'/dev/sdd','virtualName':'ephemeral2'},{'deviceName':'/dev/sde','virtualName':'ephemeral3'}],'commit':'81f01bc','description':'name=mimirdemo, arch=x86_64, ancestor_name=trustybase-x86_64-201503201659-ebs, ancestor_id=ami-95a342d1, ancestor_version=nflx-base-1.445-h396.40e956d','hypervisor':'xen','imageId':'ami-377d9e73','imageLocation':'179727101194/mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageName':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageType':'machine','jenkins':{'host':'http://spinnaker.builds.test.netflix.net/','name':'litespin','number':'3'},'name':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','ownerId':'179727101194','package_name':'mimirdemo','productCodes':[],'public':false,'region':'us-west-1','rootDeviceName':'/dev/sda1','rootDeviceType':'ebs','sourceServerGroup':'mimirdemo-test-v117','sriovNetSupport':'simple','state':'available','tags':[{'key':'appversion','value':'mimirdemo-2.0-h3.81f01bc/litespin/3'},{'key':'base_ami_version','value':'nflx-base-1.445-h396.40e956d'},{'key':'build_host','value':'http://spinnaker.builds.test.netflix.net/'},{'key':'creation_time','value':'2015-04-10 05:36:01 UTC'},{'key':'creator','value':'cfieber'}],'version':'2.0','virtualizationType':'hvm'}],'owner':{'email':'cfieber@netflix.com','name':'Cameron Fieber'},'scaleUp':{'capacity':'3','delay':'30','enabled':true},'watchers':[]},'immutable':false,'initializationStage':true,'tasks':[{'id':'1','name':'setupParallelDeploy','startTime':1429039967973,'endTime':1429039968058,'status':'SUCCEEDED'},{'id':'2','name':'setupParallelDeploy','startTime':null,'endTime':1429039968040,'status':'SUCCEEDED'},{'id':'3','name':'beginParallel','startTime':1429039967808,'endTime':1429039967927,'status':'SUCCEEDED'},{'id':'4','name':'completeParallel','startTime':1429040389311,'endTime':1429040389405,'status':'SUCCEEDED'}],'parentStageId':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35','syntheticStageOwner':'STAGE_BEFORE','scheduledTime':0},{'id':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35-2-Deployinuswest1','type':'deploy','name':'Deploy in us-west-1','startTime':1429039968094,'endTime':1429040165603,'status':'SUCCEEDED','context':{'account':'prod','amiName':'ami-717d9e35','application':'mimirdemo','availabilityZones':{'us-west-1':['us-west-1a','us-west-1c']},'baseline':{'account':'prod','cluster':'mimirdemo'},'batch.task.id.createDeploy':7,'batch.task.id.forceCacheRefresh':14,'batch.task.id.monitorDeploy':9,'batch.task.id.waitForUpInstances':13,'capacity':{'desired':1,'max':1,'min':1},'cooldown':10,'deploy.account.name':'prod','deploy.server.groups':{'us-west-1':['mimirdemo--baseline-v004']},'deploymentDetails':[{'ami':'ami-377d9e73','architecture':'x86_64','blockDeviceMappings':[{'deviceName':'/dev/sda1','ebs':{'encrypted':false,'snapshotId':'snap-4f188e6d','volumeSize':10,'volumeType':'standard'}},{'deviceName':'/dev/sdb','virtualName':'ephemeral0'},{'deviceName':'/dev/sdc','virtualName':'ephemeral1'},{'deviceName':'/dev/sdd','virtualName':'ephemeral2'},{'deviceName':'/dev/sde','virtualName':'ephemeral3'}],'commit':'81f01bc','description':'name=mimirdemo, arch=x86_64, ancestor_name=trustybase-x86_64-201503201659-ebs, ancestor_id=ami-95a342d1, ancestor_version=nflx-base-1.445-h396.40e956d','hypervisor':'xen','imageId':'ami-377d9e73','imageLocation':'179727101194/mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageName':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageType':'machine','jenkins':{'host':'http://spinnaker.builds.test.netflix.net/','name':'litespin','number':'3'},'name':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','ownerId':'179727101194','package_name':'mimirdemo','productCodes':[],'public':false,'region':'us-west-1','rootDeviceName':'/dev/sda1','rootDeviceType':'ebs','sourceServerGroup':'mimirdemo-test-v117','sriovNetSupport':'simple','state':'available','tags':[{'key':'appversion','value':'mimirdemo-2.0-h3.81f01bc/litespin/3'},{'key':'base_ami_version','value':'nflx-base-1.445-h396.40e956d'},{'key':'build_host','value':'http://spinnaker.builds.test.netflix.net/'},{'key':'creation_time','value':'2015-04-10 05:36:01 UTC'},{'key':'creator','value':'cfieber'}],'version':'2.0','virtualizationType':'hvm'}],'dirty':{'securityGroups':null},'ebsOptimized':false,'freeFormDetails':'baseline','healthCheckGracePeriod':600,'healthCheckType':'EC2','iamRole':'BaseIAMRole','instanceMonitoring':true,'instanceType':'t2.micro','kato.last.task.id':{'id':'128693'},'kato.task.id':{'id':'128693'},'kato.tasks':[{'history':[{'phase':'ORCHESTRATION','status':'Initializing Orchestration Task...'},{'phase':'ORCHESTRATION','status':'Processing op: AllowLaunchAtomicOperation'},{'phase':'ALLOW_LAUNCH','status':'Initializing Allow Launch Operation...'},{'phase':'ALLOW_LAUNCH','status':'Allowing launch of ami-717d9e35 from prod'},{'phase':'ALLOW_LAUNCH','status':'Done allowing launch of ami-717d9e35 from prod.'},{'phase':'ORCHESTRATION','status':'Orchestration completed.'},{'phase':'ORCHESTRATION','status':'Processing op: DeployAtomicOperation'},{'phase':'DEPLOY','status':'Initializing phase.'},{'phase':'DEPLOY','status':'Looking for BasicAmazonDeployDescription handler...'},{'phase':'DEPLOY','status':'Found handler: BasicAmazonDeployHandler'},{'phase':'DEPLOY','status':'Invoking Handler.'},{'phase':'DEPLOY','status':'Initializing handler...'},{'phase':'DEPLOY','status':'Preparing deployment to [us-west-1:[us-west-1a, us-west-1c]]...'},{'phase':'AWS_DEPLOY','status':'Beginning Amazon deployment.'},{'phase':'AWS_DEPLOY','status':'Looking up security groups...'},{'phase':'AWS_DEPLOY','status':'Beginning ASG deployment.'},{'phase':'AWS_DEPLOY','status':'Found ancestor ASG: parsing details.'},{'phase':'AWS_DEPLOY','status':'Building launch configuration for new ASG.'},{'phase':'AWS_DEPLOY','status':'Deploying ASG.'},{'phase':'AWS_DEPLOY','status':' > Deploying to subnetIds: subnet-255cb87c,subnet-c8a80fad'},{'phase':'DEPLOY','status':'Server Groups: [us-west-1:mimirdemo--baseline-v004] created.'},{'phase':'ORCHESTRATION','status':'Orchestration completed.'}],'id':'128693','resultObjects':[{'amiId':'ami-717d9e35','amiName':'ami-717d9e35','region':'us-west-1'},{'asgNameByRegion':{'us-west-1':'mimirdemo--baseline-v004'},'messages':[],'serverGroupNames':['us-west-1:mimirdemo--baseline-v004']}],'status':{'completed':true,'failed':false}}],'keyPair':'nf-prod-keypair-a','loadBalancers':['mimirdemo--frontend'],'name':{'bytes':'RGVwbG95IGluIHVzLXdlc3QtMQ==','strings':['Deploy in ',''],'valueCount':1,'values':['us-west-1']},'notification.type':'createdeploy','owner':{'email':'cfieber@netflix.com','name':'Cameron Fieber'},'provider':'aws','scaleUp':{'capacity':'3','delay':'30','enabled':true},'securityGroups':['sg-b575ded0','sg-b775ded2','sg-121caa77'],'stack':'','strategy':'highlander','subnetType':'internal (vpc0)','suspendedProcesses':[],'terminationPolicies':['Default'],'type':'linearDeploy','watchers':[]},'immutable':false,'initializationStage':false,'tasks':[{'id':'1','name':'createDeploy','startTime':1429039968809,'endTime':1429039969226,'status':'SUCCEEDED'},{'id':'2','name':'monitorDeploy','startTime':1429039969266,'endTime':1429039996960,'status':'SUCCEEDED'},{'id':'3','name':'forceCacheRefresh','startTime':1429039996988,'endTime':1429039997257,'status':'SUCCEEDED'},{'id':'4','name':'waitForUpInstances','startTime':1429039997285,'endTime':1429040164827,'status':'SUCCEEDED'},{'id':'5','name':'forceCacheRefresh','startTime':1429040164858,'endTime':1429040165599,'status':'SUCCEEDED'}],'parentStageId':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35-1-DeployCanary','syntheticStageOwner':'STAGE_AFTER','scheduledTime':0},{'id':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35-3-destroyAsg','type':'destroyAsg','name':'destroyAsg','startTime':1429040165624,'endTime':1429040359275,'status':'SUCCEEDED','context':{'asgName':'mimirdemo--baseline-v003','batch.task.id.destroyAsg':15,'batch.task.id.forceCacheRefresh':20,'batch.task.id.monitorAsg':16,'batch.task.id.waitForDestroyedAsg':21,'credentials':'prod','deploy.account.name':'prod','deploy.server.groups':{'us-west-1':['mimirdemo--baseline-v003']},'deploymentDetails':[{'ami':'ami-377d9e73','architecture':'x86_64','blockDeviceMappings':[{'deviceName':'/dev/sda1','ebs':{'encrypted':false,'snapshotId':'snap-4f188e6d','volumeSize':10,'volumeType':'standard'}},{'deviceName':'/dev/sdb','virtualName':'ephemeral0'},{'deviceName':'/dev/sdc','virtualName':'ephemeral1'},{'deviceName':'/dev/sdd','virtualName':'ephemeral2'},{'deviceName':'/dev/sde','virtualName':'ephemeral3'}],'commit':'81f01bc','description':'name=mimirdemo, arch=x86_64, ancestor_name=trustybase-x86_64-201503201659-ebs, ancestor_id=ami-95a342d1, ancestor_version=nflx-base-1.445-h396.40e956d','hypervisor':'xen','imageId':'ami-377d9e73','imageLocation':'179727101194/mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageName':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageType':'machine','jenkins':{'host':'http://spinnaker.builds.test.netflix.net/','name':'litespin','number':'3'},'name':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','ownerId':'179727101194','package_name':'mimirdemo','productCodes':[],'public':false,'region':'us-west-1','rootDeviceName':'/dev/sda1','rootDeviceType':'ebs','sourceServerGroup':'mimirdemo-test-v117','sriovNetSupport':'simple','state':'available','tags':[{'key':'appversion','value':'mimirdemo-2.0-h3.81f01bc/litespin/3'},{'key':'base_ami_version','value':'nflx-base-1.445-h396.40e956d'},{'key':'build_host','value':'http://spinnaker.builds.test.netflix.net/'},{'key':'creation_time','value':'2015-04-10 05:36:01 UTC'},{'key':'creator','value':'cfieber'}],'version':'2.0','virtualizationType':'hvm'}],'kato.last.task.id':{'id':'128717'},'kato.task.id':{'id':'128717'},'kato.tasks':[{'history':[{'phase':'ORCHESTRATION','status':'Initializing Orchestration Task...'},{'phase':'ORCHESTRATION','status':'Processing op: DestroyAsgAtomicOperation'},{'phase':'DESTROY_ASG','status':'Initializing ASG Destroy Operation...'},{'phase':'DESTROY_ASG','status':'Looking up instance ids for mimirdemo--baseline-v003 in us-west-1...'},{'phase':'DESTROY_ASG','status':'Force deleting mimirdemo--baseline-v003 in us-west-1.'},{'phase':'DESTROY_ASG','status':'Deleting launch config mimirdemo--baseline-v003-04132015073700 in us-west-1.'},{'phase':'DESTROY_ASG','status':'Issuing terminate instances request for 1 instances.'},{'phase':'DESTROY_ASG','status':'Done destroying mimirdemo--baseline-v003 in [us-west-1].'},{'phase':'ORCHESTRATION','status':'Orchestration completed.'}],'id':'128717','resultObjects':[],'status':{'completed':true,'failed':false}}],'notification.type':'destroyasg','regions':['us-west-1']},'immutable':false,'initializationStage':false,'tasks':[{'id':'1','name':'destroyAsg','startTime':1429040165627,'endTime':1429040166002,'status':'SUCCEEDED'},{'id':'2','name':'monitorAsg','startTime':1429040166029,'endTime':1429040169572,'status':'SUCCEEDED'},{'id':'3','name':'forceCacheRefresh','startTime':1429040169603,'endTime':1429040170943,'status':'SUCCEEDED'},{'id':'4','name':'waitForDestroyedAsg','startTime':1429040170969,'endTime':1429040359272,'status':'SUCCEEDED'}],'parentStageId':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35-2-Deployinuswest1','syntheticStageOwner':'STAGE_AFTER','scheduledTime':0},{'id':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35-4-Deployinuswest1','type':'deploy','name':'Deploy in us-west-1','startTime':1429039968079,'endTime':1429040167040,'status':'SUCCEEDED','context':{'account':'prod','application':'mimirdemo','availabilityZones':{'us-west-1':['us-west-1a','us-west-1c']},'baseline':{'account':'prod','cluster':'mimirdemo'},'batch.task.id.createDeploy':6,'batch.task.id.forceCacheRefresh':17,'batch.task.id.monitorDeploy':8,'batch.task.id.waitForUpInstances':11,'capacity':{'desired':1,'max':1,'min':1},'cooldown':10,'deploy.account.name':'prod','deploy.server.groups':{'us-west-1':['mimirdemo--canary-v004']},'deploymentDetails':[{'ami':'ami-377d9e73','architecture':'x86_64','blockDeviceMappings':[{'deviceName':'/dev/sda1','ebs':{'encrypted':false,'snapshotId':'snap-4f188e6d','volumeSize':10,'volumeType':'standard'}},{'deviceName':'/dev/sdb','virtualName':'ephemeral0'},{'deviceName':'/dev/sdc','virtualName':'ephemeral1'},{'deviceName':'/dev/sdd','virtualName':'ephemeral2'},{'deviceName':'/dev/sde','virtualName':'ephemeral3'}],'commit':'81f01bc','description':'name=mimirdemo, arch=x86_64, ancestor_name=trustybase-x86_64-201503201659-ebs, ancestor_id=ami-95a342d1, ancestor_version=nflx-base-1.445-h396.40e956d','hypervisor':'xen','imageId':'ami-377d9e73','imageLocation':'179727101194/mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageName':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageType':'machine','jenkins':{'host':'http://spinnaker.builds.test.netflix.net/','name':'litespin','number':'3'},'name':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','ownerId':'179727101194','package_name':'mimirdemo','productCodes':[],'public':false,'region':'us-west-1','rootDeviceName':'/dev/sda1','rootDeviceType':'ebs','sourceServerGroup':'mimirdemo-test-v117','sriovNetSupport':'simple','state':'available','tags':[{'key':'appversion','value':'mimirdemo-2.0-h3.81f01bc/litespin/3'},{'key':'base_ami_version','value':'nflx-base-1.445-h396.40e956d'},{'key':'build_host','value':'http://spinnaker.builds.test.netflix.net/'},{'key':'creation_time','value':'2015-04-10 05:36:01 UTC'},{'key':'creator','value':'cfieber'}],'version':'2.0','virtualizationType':'hvm'}],'dirty':{'securityGroups':null},'ebsOptimized':false,'freeFormDetails':'canary','healthCheckGracePeriod':600,'healthCheckType':'EC2','iamRole':'BaseIAMRole','instanceMonitoring':true,'instanceType':'t2.micro','kato.last.task.id':{'id':'128692'},'kato.task.id':{'id':'128692'},'kato.tasks':[{'history':[{'phase':'ORCHESTRATION','status':'Initializing Orchestration Task...'},{'phase':'ORCHESTRATION','status':'Processing op: AllowLaunchAtomicOperation'},{'phase':'ALLOW_LAUNCH','status':'Initializing Allow Launch Operation...'},{'phase':'ALLOW_LAUNCH','status':'Allowing launch of ami-377d9e73 from prod'},{'phase':'ALLOW_LAUNCH','status':'Done allowing launch of ami-377d9e73 from prod.'},{'phase':'ORCHESTRATION','status':'Orchestration completed.'},{'phase':'ORCHESTRATION','status':'Processing op: DeployAtomicOperation'},{'phase':'DEPLOY','status':'Initializing phase.'},{'phase':'DEPLOY','status':'Looking for BasicAmazonDeployDescription handler...'},{'phase':'DEPLOY','status':'Found handler: BasicAmazonDeployHandler'},{'phase':'DEPLOY','status':'Invoking Handler.'},{'phase':'DEPLOY','status':'Initializing handler...'},{'phase':'DEPLOY','status':'Preparing deployment to [us-west-1:[us-west-1a, us-west-1c]]...'},{'phase':'AWS_DEPLOY','status':'Beginning Amazon deployment.'},{'phase':'AWS_DEPLOY','status':'Looking up security groups...'},{'phase':'AWS_DEPLOY','status':'Beginning ASG deployment.'},{'phase':'AWS_DEPLOY','status':'Found ancestor ASG: parsing details.'},{'phase':'AWS_DEPLOY','status':'Building launch configuration for new ASG.'},{'phase':'AWS_DEPLOY','status':'Deploying ASG.'},{'phase':'AWS_DEPLOY','status':' > Deploying to subnetIds: subnet-255cb87c,subnet-c8a80fad'},{'phase':'DEPLOY','status':'Server Groups: [us-west-1:mimirdemo--canary-v004] created.'},{'phase':'ORCHESTRATION','status':'Orchestration completed.'}],'id':'128692','resultObjects':[{'amiId':'ami-377d9e73','amiName':'ami-377d9e73','region':'us-west-1'},{'asgNameByRegion':{'us-west-1':'mimirdemo--canary-v004'},'messages':[],'serverGroupNames':['us-west-1:mimirdemo--canary-v004']}],'status':{'completed':true,'failed':false}}],'keyPair':'nf-prod-keypair-a','loadBalancers':['mimirdemo--frontend'],'name':{'bytes':'RGVwbG95IGluIHVzLXdlc3QtMQ==','strings':['Deploy in ',''],'valueCount':1,'values':['us-west-1']},'notification.type':'createdeploy','owner':{'email':'cfieber@netflix.com','name':'Cameron Fieber'},'provider':'aws','scaleUp':{'capacity':'3','delay':'30','enabled':true},'securityGroups':['sg-b575ded0','sg-b775ded2','sg-121caa77'],'stack':'','strategy':'highlander','subnetType':'internal (vpc0)','suspendedProcesses':[],'terminationPolicies':['Default'],'type':'linearDeploy','watchers':[]},'immutable':false,'initializationStage':false,'tasks':[{'id':'1','name':'createDeploy','startTime':1429039968086,'endTime':1429039969223,'status':'SUCCEEDED'},{'id':'2','name':'monitorDeploy','startTime':1429039969262,'endTime':1429039988209,'status':'SUCCEEDED'},{'id':'3','name':'forceCacheRefresh','startTime':1429039988236,'endTime':1429039988992,'status':'SUCCEEDED'},{'id':'4','name':'waitForUpInstances','startTime':1429039989024,'endTime':1429040166348,'status':'SUCCEEDED'},{'id':'5','name':'forceCacheRefresh','startTime':1429040166378,'endTime':1429040167036,'status':'SUCCEEDED'}],'parentStageId':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35-1-DeployCanary','syntheticStageOwner':'STAGE_AFTER','scheduledTime':0},{'id':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35-5-destroyAsg','type':'destroyAsg','name':'destroyAsg','startTime':1429040167060,'endTime':1429040389277,'status':'SUCCEEDED','context':{'asgName':'mimirdemo--canary-v003','batch.task.id.destroyAsg':18,'batch.task.id.forceCacheRefresh':22,'batch.task.id.monitorAsg':19,'batch.task.id.waitForDestroyedAsg':23,'credentials':'prod','deploy.account.name':'prod','deploy.server.groups':{'us-west-1':['mimirdemo--canary-v003']},'deploymentDetails':[{'ami':'ami-377d9e73','architecture':'x86_64','blockDeviceMappings':[{'deviceName':'/dev/sda1','ebs':{'encrypted':false,'snapshotId':'snap-4f188e6d','volumeSize':10,'volumeType':'standard'}},{'deviceName':'/dev/sdb','virtualName':'ephemeral0'},{'deviceName':'/dev/sdc','virtualName':'ephemeral1'},{'deviceName':'/dev/sdd','virtualName':'ephemeral2'},{'deviceName':'/dev/sde','virtualName':'ephemeral3'}],'commit':'81f01bc','description':'name=mimirdemo, arch=x86_64, ancestor_name=trustybase-x86_64-201503201659-ebs, ancestor_id=ami-95a342d1, ancestor_version=nflx-base-1.445-h396.40e956d','hypervisor':'xen','imageId':'ami-377d9e73','imageLocation':'179727101194/mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageName':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','imageType':'machine','jenkins':{'host':'http://spinnaker.builds.test.netflix.net/','name':'litespin','number':'3'},'name':'mimirdemo-2.0-h3.81f01bc-x86_64-201504100532-trusty-hvm-sriov-ebs','ownerId':'179727101194','package_name':'mimirdemo','productCodes':[],'public':false,'region':'us-west-1','rootDeviceName':'/dev/sda1','rootDeviceType':'ebs','sourceServerGroup':'mimirdemo-test-v117','sriovNetSupport':'simple','state':'available','tags':[{'key':'appversion','value':'mimirdemo-2.0-h3.81f01bc/litespin/3'},{'key':'base_ami_version','value':'nflx-base-1.445-h396.40e956d'},{'key':'build_host','value':'http://spinnaker.builds.test.netflix.net/'},{'key':'creation_time','value':'2015-04-10 05:36:01 UTC'},{'key':'creator','value':'cfieber'}],'version':'2.0','virtualizationType':'hvm'}],'kato.last.task.id':{'id':'128718'},'kato.task.id':{'id':'128718'},'kato.tasks':[{'history':[{'phase':'ORCHESTRATION','status':'Initializing Orchestration Task...'},{'phase':'ORCHESTRATION','status':'Processing op: DestroyAsgAtomicOperation'},{'phase':'DESTROY_ASG','status':'Initializing ASG Destroy Operation...'},{'phase':'DESTROY_ASG','status':'Looking up instance ids for mimirdemo--canary-v003 in us-west-1...'},{'phase':'DESTROY_ASG','status':'Force deleting mimirdemo--canary-v003 in us-west-1.'},{'phase':'DESTROY_ASG','status':'Deleting launch config mimirdemo--canary-v003-04132015073700 in us-west-1.'},{'phase':'DESTROY_ASG','status':'Issuing terminate instances request for 1 instances.'},{'phase':'DESTROY_ASG','status':'Done destroying mimirdemo--canary-v003 in [us-west-1].'},{'phase':'ORCHESTRATION','status':'Orchestration completed.'}],'id':'128718','resultObjects':[],'status':{'completed':true,'failed':false}}],'notification.type':'destroyasg','regions':['us-west-1']},'immutable':false,'initializationStage':false,'tasks':[{'id':'1','name':'destroyAsg','startTime':1429040167063,'endTime':1429040167285,'status':'SUCCEEDED'},{'id':'2','name':'monitorAsg','startTime':1429040167316,'endTime':1429040179535,'status':'SUCCEEDED'},{'id':'3','name':'forceCacheRefresh','startTime':1429040179561,'endTime':1429040179805,'status':'SUCCEEDED'},{'id':'4','name':'waitForDestroyedAsg','startTime':1429040179850,'endTime':1429040389274,'status':'SUCCEEDED'}],'parentStageId':'5f73cc68-913e-4fdf-9b67-b8194d1b3a35-4-Deployinuswest1','syntheticStageOwner':'STAGE_AFTER','scheduledTime':0}],'canceled':false,'name':'canarytest','pipelineConfigId':'7a4c4960-df38-11e4-bbde-45f3bbb0924b','trigger':{'enabled':false,'type':'manual','master':'spinnaker','job':'litespin','buildNumber':3,'description':'spinnaker: litespin','user':'[anonymous]','buildInfo':{'building':false,'number':3,'result':'SUCCESS','timestamp':'1428643910079','duration':13462,'url':'http://spinnaker.builds.test.netflix.net/job/litespin/3/','artifacts':[{'fileName':'mimirdemo_2.0-h3.81f01bc_all.deb','displayPath':'mimirdemo_2.0-h3.81f01bc_all.deb','relativePath':'repo/build/distributions/mimirdemo_2.0-h3.81f01bc_all.deb'}],'scm':{'ref':'origin/master','branch':'master','sha1':'81f01bc4cdcb1dff64173451a266a2984889918b'}}},'initialConfig':{},'startTime':1429039967364,'status':'SUCCEEDED','endTime':1429040389277}];
        stub.forEach(executionsTransformer.transformExecution);
        return $q.when(stub);
      }

      var deferred = $q.defer();
      $http({
        method: 'GET',
        transformResponse: appendTransform(function(executions) {
          if (!executions || !executions.length) {
            return [];
          }
          executions.forEach(executionsTransformer.transformExecution);
          return executions;
        }),
        url: [
          settings.gateUrl,
          'applications',
          applicationName,
          'pipelines',
        ].join('/'),
      }).then(
        function(resp) {
          deferred.resolve(resp.data);
        },
        function(resp) {
          deferred.reject(resp);
        }
      );
      return deferred.promise;
    }

    function waitUntilNewTriggeredPipelineAppears(application, pipelineName, triggeredPipelineId) {

      return application.reloadExecutions().then(function() {
        var executions = application.executions;
        var match = executions.filter(function(execution) {
          return execution.id === triggeredPipelineId;
        });
        var deferred = $q.defer();
        if (match && match.length) {
          deferred.resolve();
          return deferred.promise;
        } else {
          return $timeout(function() {
            return waitUntilNewTriggeredPipelineAppears(application, pipelineName, triggeredPipelineId);
          }, 1000);
        }
      });
    }

    function cancelExecution(executionId) {
      var deferred = $q.defer();
      $http({
        method: 'PUT',
        url: [
          settings.gateUrl,
          'applications',
          $stateParams.application,
          'pipelines',
          executionId,
          'cancel',
        ].join('/')
      }).then(
          function() {
            scheduler.scheduleImmediate();
            deferred.resolve();
          },
          function(exception) {
            deferred.reject(exception && exception.data ? exception.message : null);
          }
        );
      return deferred.promise;
    }

    function deleteExecution(application, executionId) {
      var deferred = $q.defer();
      $http({
        method: 'DELETE',
        url: [
          settings.gateUrl,
          'pipelines',
          executionId,
        ].join('/')
      }).then(
        function() {
          application.reloadExecutions().then(deferred.resolve);
        },
        function(exception) {
          deferred.reject(exception && exception.data ? exception.data.message : null);
        }
      );
      return deferred.promise;
    }

    function getSectionCacheKey(groupBy, application, heading) {
      return ['pipeline', groupBy, application, heading].join('#');
    }

    return {
      getAll: getExecutions,
      cancelExecution: cancelExecution,
      deleteExecution: deleteExecution,
      forceRefresh: scheduler.scheduleImmediate,
      subscribeAll: function(fn) {
        return scheduler
          .get()
          .flatMap(function() {
            return RxService.Observable.fromPromise(getExecutions($stateParams.application));
          })
          .subscribe(fn);
      },
      waitUntilNewTriggeredPipelineAppears: waitUntilNewTriggeredPipelineAppears,
      getSectionCacheKey: getSectionCacheKey,
    };
  });
